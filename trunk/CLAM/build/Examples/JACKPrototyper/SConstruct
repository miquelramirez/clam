import sys,os,glob

if sys.platform != 'darwin':
	print "ERROR: at this moment this example only compiles in OSX"
	sys.exit(1)

print """
#############################################################
WARNING: to compile this example properly first you must make
sure that the source files of this project have new-style headers!!!!"
 -This folders are to be converted in CLAM/examples:
	QtDesignerPlugins and Prototyper
#############################################################"""

jprot_env = Environment( tools=['default','qt']) 
jprot_env.Replace( QT_UIC='/Developer/qt/bin/uic' )
jprot_env.Replace(QT_LIB='qt-mt')

opts = Options('Annotator.conf')

opts.Add( PathOption( 'clam_prefix', 'Prefix were CLAM was installed', '/usr/local') )
opts.Add( BoolOption( 'release', 'Build CLAM [JACK] Prototyper enabling compiler optimizations', 'yes') )
opts.Update(jprot_env)
opts.Save('JACKPrototyper.conf', jprot_env)
Help(opts.GenerateHelpText(jprot_env))

if jprot_env['release'] :
	jprot_env.Append( CPPFLAGS=['-O3','-fomit-frame-pointer','-Wall'] )
else :
	jprot_env.Append( CPPFLAGS=['-g', '-Wall'] )

export_pkg_config = 'export PKG_CONFIG_PATH='+jprot_env['clam_prefix']+'/lib/pkgconfig'
execute_pkg_config = 'pkg-config --cflags --libs clam_core clam_processing clam_audioio clam_vmqt' 
jprot_env.ParseConfig( export_pkg_config + ' && ' + execute_pkg_config  )

sourcefiles=['../../../examples/Prototyper/JACKPrototyper.cxx',
	'../../../examples/Prototyper/PrototypeLoader.cxx',
	'../../../examples/Prototyper/QtSlot2Control.cxx',
	'../../../examples/QtDesignerPlugins/CLAMWidgetsPlugin.cxx']

bin_objects = [ jprot_env.Object(source) for source in sourcefiles ]

jprot_env.Append(CPPPATH='.')

jprot_env.Append(CPPFLAGS=['-include', 'CLAM/preinclude.hxx'])
jprot_env.Append(LINKFLAGS=['-dynamic','-bind_at_load'])
jprot_env.Append(LIBS=['qui'])

jprot_bin_pre = jprot_env.Program( 'JACKPrototyper', bin_objects )

bundle_bin = jprot_env.Install( 'JACKPrototyper.app/Contents/MacOS', jprot_bin_pre )
bundle_data = jprot_env.Install( 'JACKPrototyper.app/Contents', 'mac_resources/Info.plist')
bundle_icon = jprot_env.Install( 'JACKPrototyper.app/Contents/Resources', 'mac_resources/CLAM.icns')

jprot_bin = [ bundle_bin + bundle_data + bundle_icon ]
		
Default(jprot_bin)
